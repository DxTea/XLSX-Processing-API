# XLSX Processing API

## Описание проекта

Проект представляет собой API на основе FastAPI для обработки XLSX-файлов. Он выполняет следующие задачи:

1. **Чтение и обработка XLSX-файлов**:
   - Чтение данных из XLSX-файла.
   - Нормализация данных: замена символа `I` на `1` в колонке `ID Материала`, преобразование числовых значений с удалением единиц измерения (`М3`, `КГ`, `Т`, `шт` и т.д.).
   - Фильтрация строк, где значение в колонке `Кол-во по заявке` больше, чем в `Поступило всего`.
   - Добавление новой колонки `Расхождение заявка-приход`, содержащей разницу между `Кол-во по заявке` и `Поступило всего`.
   - Сохранение результата в новый XLSX-файл.

2. **API-эндпоинты**:
   - `POST /upload`: Принимает XLSX-файл и возвращает уникальный `task_id` для отслеживания задачи.
   - `GET /status/{task_id}`: Возвращает статус задачи (`pending`, `success`, `failed`) и, при необходимости, описание ошибки.
   - `GET /result/{task_id}`: Возвращает обработанный XLSX-файл, если задача завершена успешно, или ошибку 404, если задача не завершена.

3. **Тестирование**:
   - Проект покрыт тестами с использованием `pytest`, которые проверяют как обработку файлов, так и функциональность API.

## Структура проекта

```bash
fastApiProject/
├── temp/                    # Директория для временных файлов (входные и выходные XLSX)
├── file_processing.py       # Модуль для обработки XLSX-файлов
├── main.py                  # Основной файл FastAPI-приложения
├── test_file_processing.py  # Тесты для модуля file_processing
├── test_main.py             # Тесты для API
├── README.md                # Документация проекта
└── requirements.txt         # Зависимости проекта
```

## Установка

1. **Клонируйте репозиторий**:
   ```bash
   git clone <URL_репозитория>
   cd fastApiProject
   ```

2. **Создайте виртуальное окружение**:
   ```bash
   python -m venv .venv
   source .venv/bin/activate  # На Windows: .venv\Scripts\activate
   ```

3. **Установите зависимости**:
   ```bash
   pip install -r requirements.txt
   ```

4. **Запустите приложение**:
   ```bash
   uvicorn main:app --reload
   ```

   API будет доступно по адресу `http://127.0.0.1:8000`.

## Использование

### Эндпоинты API

1. **POST /upload**
   - **Описание**: Загружает XLSX-файл для обработки.
   - **Входные данные**: Файл в формате `multipart/form-data` с расширением `.xlsx`.
   - **Ответ**:
     ```json
     {"task_id": "<uuid>"}
     ```
   - **Пример**:
     ```bash
     curl -X POST -F "file=@test.xlsx" http://127.0.0.1:8000/upload
     ```

2. **GET /status/{task_id}**
   - **Описание**: Возвращает статус задачи по её `task_id`.
   - **Ответ**:
     ```json
     {
       "task_id": "<uuid>",
       "status": "pending|success|failed",
       "error": null | "описание ошибки",
     }
     ```
   - **Пример**:
     ```bash
     curl http://127.0.0.1:8000/status/<task_id>
     ```

3. **GET /result/{task_id}**
   - **Описание**: Возвращает обработанный XLSX-файл, если задача завершена успешно.
   - **Ответ**: Файл `.xlsx` или ошибка 404, если задача не завершена.
   - **Пример**:
     ```bash
     curl -O http://127.0.0.1:8000/result/<task_id>
     ```

### Пример входного XLSX-файла

Файл должен содержать как минимум следующие колонки:
- `ID Материала`: Может содержать символ `I`, который будет заменён на `1`.
- `Поступило всего`: Числовое значение или строка с единицами измерения (например, `100 М3`).
- `Кол-во по заявке`: Числовое значение или строка с единицами измерения.

Пример данных:
| ID Материала | Поступило всего | Кол-во по заявке | Наименование ТМЦ       |
|--------------|-----------------|------------------|------------------------|
| I46872       | 506.0           | 358 М3           | Бетонная смесь B25     |
| 694304       | 369.0           | 80 М3            | Бетонная смесь B25     |
| 727698       | 723.0           | 934 КГ           | Гайка М20              |

### Пример выходного XLSX-файла

После обработки останутся строки, где `Кол-во по заявке` > `Поступило всего`, с добавленной колонкой `Расхождение заявка-приход`. Пример:

| ID Материала | Поступило всего | Кол-во по заявке | Наименование ТМЦ | Расхождение заявка-приход |
|--------------|-----------------|------------------|------------------|---------------------------|
| 727698       | 723.0           | 934.0            | Гайка М20        | 211.0                     |

## Тестирование

Для запуска тестов выполните:

```bash
pytest
```

Тесты включают:
- Проверку нормализации числовых значений и замены `I` на `1`.
- Проверку фильтрации строк и добавления колонки `Расхождение заявка-приход`.
- Проверку API-эндпоинтов: загрузка файлов, получение статуса и результата, обработка ошибок.

## Зависимости

- **Python**: 3.12+
- **FastAPI**: Для создания API.
- **Pandas** и **Openpyxl**: Для обработки XLSX-файлов.
- **Pytest** и **Pytest-asyncio**: Для тестирования.
- **Uvicorn**: Для запуска сервера.

## Замечания

- Временные файлы сохраняются в директории `temp/` и автоматически удаляются через 1 час.
